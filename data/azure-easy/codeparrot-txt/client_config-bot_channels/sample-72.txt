terraform {
  required_providers {
    azurerm = {
      source  = "hashicorp/azurerm"
    }
  }
}

# Provider block with azurerm resource group
resource "azurerm_resource_group" "rg" {
  name     = "myTFResourceGroup"
  location = "westus2"
}

# create resource group policy
resource "azurerm_resource_group_policy" "policy" {
  name   = "myTFPolicy"
  location = "westus2"
  resource_group_name = azurerm_resource_group.rg.name
}

# data block, azurem client config file
data "template_file" "user_data" {
  template = file("${path.module}/user_data.tpl")
  vars = {
    access_key = var.access_key
    secret_key = var.secret_key
    subscription_id = var.subscription_id
    client_id = var.client_id
  }
}

# create bot channels registration resource
resource "azurerm_bot_application_registration" "bot_registration" {
  name                = "myTFBotRegistration"
  resource_group_name = azurerm_resource_group.rg.name
  location            = "westus2"
  sku                 = "Standard"
  webhook_url          = "https://hooks.azure.com/subscriptions/${var.subscription_id}/resourceGroups/${azurerm_resource_group.rg.name}/providers/Microsoft.Web/serverfarms/add"
  token_key           = var.token_key
  token_secret        = var.token_secret
  tenant_id           = var.tenant_id
  ssl_enforcement     = var.ssl_enforcement
  ssl_enforcement_timeout = var.ssl_enforcement_timeout
  version              = "12.0.0"
}

