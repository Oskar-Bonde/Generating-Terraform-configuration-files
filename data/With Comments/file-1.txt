# raw-data/hashicorp-certified-terraform\02-Terraform-Basics\02-03-Terraform-Language-Syntax\terraform-manifests
# Terraform block with the AWS provider and Backend as S3 for Remote State Storage with State Locking in us-east-1
terraform {
  required_version = "~> 0.14"
  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "~> 3.0"
    }
  }
  backend "s3" {
    bucket = "terraform-stacksimplify"
    key    = "dev2/terraform.tfstate"
    region = "us-east-1"  
    dynamodb_table = "terraform-dev-state-table"
  }
}

# Provider block with AWS in us-east-1
provider "aws" {
  profile = "default" 
  region  = "us-east-1"
}

# Resource block with an EC2 instance called ec2demo with the var.instance_type instance type and ami-0ff8a91507f77f867
resource "aws_instance" "ec2demo" {
  ami           = "ami-0ff8a91507f77f867"
  instance_type = var.instance_type
}

# Variable block called instance_type of type string and default t2.micro
variable "instance_type" {
  default = "t2.micro"
  type = string
}

# Output block called ec2_instance_publicip with the public ip of my AWS instance
output "ec2_instance_publicip" {
  value = aws_instance.my-ec2-vm.public_ip
}

# Locals block that creates a S3 bucket with input variables and local values
locals {
  bucket-name-prefix = "${var.app_name}-${var.environment_name}"
}

# Data block that has latest AMI ID for Amazon Linux2 OS
data "aws_ami" "amzlinux" {
  most_recent      = true
  owners           = ["amazon"]

  filter {
    name   = "name"
    values = ["amzn2-ami-hvm-*"]
  }

  filter {
    name   = "root-device-type"
    values = ["ebs"]
  }

  filter {
    name   = "virtualization-type"
    values = ["hvm"]
  }

  filter {
    name   = "architecture"
    values = ["x86_64"]
  }
}

# Module block off an AWS EC2 Instance that has default VPC security group ID and public subnet id from default vpc
module "ec2_cluster" {
  source                 = "terraform-aws-modules/ec2-instance/aws"
  version                = "~> 2.0"

  name                   = "my-modules-demo"
  instance_count         = 2

  ami                    = data.aws_ami.amzlinux.id
  instance_type          = "t2.micro"
  key_name               = "terraform-key"
  monitoring             = true
  vpc_security_group_ids = ["sg-08b25c5a5bf489ffa"] 
  subnet_id              = "subnet-4ee95470"
  user_data               = file("apache-install.sh")

  tags = {
    Terraform   = "true"
    Environment = "dev"
  }
}
